import env from"./core/env";import*as zrUtil from"./core/util";import Handler from"./Handler";import Storage from"./Storage";import Animation from"./animation/Animation";import HandlerProxy from"./dom/HandlerProxy";import{lum}from"./tool/color";import{DARK_MODE_THRESHOLD}from"./config";import Group from"./graphic/Group";var useVML=!env.canvasSupported,painterCtors={},instances={};function delInstance(t){delete instances[t]}function isDarkMode(t){if(!t)return!1;if("string"==typeof t)return lum(t,1)<DARK_MODE_THRESHOLD;if(t.colorStops){for(var e=t.colorStops,r=0,o=e.length,i=0;i<o;i++)r+=lum(e[i].color,1);return(r/=o)<DARK_MODE_THRESHOLD}return!1}var ZRender=function(){function t(t,e,r){var o=this;this._sleepAfterStill=10,this._stillFrameAccum=0,this._needsRefresh=!0,this._needsRefreshHover=!0,this._darkMode=!1,r=r||{},this.dom=e,this.id=t;var i=new Storage,n=r.renderer||"canvas";if(useVML)throw new Error("IE8 support has been dropped since 5.0");if(painterCtors[n]||(n=zrUtil.keys(painterCtors)[0]),!painterCtors[n])throw new Error("Renderer '"+n+"' is not imported. Please import it first.");r.useDirtyRect=null!=r.useDirtyRect&&r.useDirtyRect;var s=new painterCtors[n](e,i,r,t);this.storage=i,this.painter=s;var a=env.node||env.worker?null:new HandlerProxy(s.getViewportRoot(),s.root);this.handler=new Handler(i,s,a,s.root),this.animation=new Animation({stage:{update:function(){return o._flush(!0)}}}),this.animation.start()}return t.prototype.add=function(t){t&&(this.storage.addRoot(t),t.addSelfToZr(this),this.refresh())},t.prototype.remove=function(t){t&&(this.storage.delRoot(t),t.removeSelfFromZr(this),this.refresh())},t.prototype.configLayer=function(t,e){this.painter.configLayer&&this.painter.configLayer(t,e),this.refresh()},t.prototype.setBackgroundColor=function(t){this.painter.setBackgroundColor&&this.painter.setBackgroundColor(t),this.refresh(),this._backgroundColor=t,this._darkMode=isDarkMode(t)},t.prototype.getBackgroundColor=function(){return this._backgroundColor},t.prototype.setDarkMode=function(t){this._darkMode=t},t.prototype.isDarkMode=function(){return this._darkMode},t.prototype.refreshImmediately=function(t){t||this.animation.update(!0),this._needsRefresh=!1,this.painter.refresh(),this._needsRefresh=!1},t.prototype.refresh=function(){this._needsRefresh=!0,this.animation.start()},t.prototype.flush=function(){this._flush(!1)},t.prototype._flush=function(t){var e,r=(new Date).getTime();this._needsRefresh&&(e=!0,this.refreshImmediately(t)),this._needsRefreshHover&&(e=!0,this.refreshHoverImmediately());var o=(new Date).getTime();e?(this._stillFrameAccum=0,this.trigger("rendered",{elapsedTime:o-r})):this._sleepAfterStill>0&&(this._stillFrameAccum++,this._stillFrameAccum>this._sleepAfterStill&&this.animation.stop())},t.prototype.setSleepAfterStill=function(t){this._sleepAfterStill=t},t.prototype.wakeUp=function(){this.animation.start(),this._stillFrameAccum=0},t.prototype.addHover=function(t){},t.prototype.removeHover=function(t){},t.prototype.clearHover=function(){},t.prototype.refreshHover=function(){this._needsRefreshHover=!0},t.prototype.refreshHoverImmediately=function(){this._needsRefreshHover=!1,this.painter.refreshHover&&"canvas"===this.painter.getType()&&this.painter.refreshHover()},t.prototype.resize=function(t){this.painter.resize((t=t||{}).width,t.height),this.handler.resize()},t.prototype.clearAnimation=function(){this.animation.clear()},t.prototype.getWidth=function(){return this.painter.getWidth()},t.prototype.getHeight=function(){return this.painter.getHeight()},t.prototype.pathToImage=function(t,e){if(this.painter.pathToImage)return this.painter.pathToImage(t,e)},t.prototype.setCursorStyle=function(t){this.handler.setCursorStyle(t)},t.prototype.findHover=function(t,e){return this.handler.findHover(t,e)},t.prototype.on=function(t,e,r){return this.handler.on(t,e,r),this},t.prototype.off=function(t,e){this.handler.off(t,e)},t.prototype.trigger=function(t,e){this.handler.trigger(t,e)},t.prototype.clear=function(){for(var t=this.storage.getRoots(),e=0;e<t.length;e++)t[e]instanceof Group&&t[e].removeSelfFromZr(this);this.storage.delAllRoots(),this.painter.clear()},t.prototype.dispose=function(){this.animation.stop(),this.clear(),this.storage.dispose(),this.painter.dispose(),this.handler.dispose(),this.animation=this.storage=this.painter=this.handler=null,delInstance(this.id)},t}();export function init(t,e){var r=new ZRender(zrUtil.guid(),t,e);return instances[r.id]=r,r}export function dispose(t){t.dispose()}export function disposeAll(){for(var t in instances)instances.hasOwnProperty(t)&&instances[t].dispose();instances={}}export function getInstance(t){return instances[t]}export function registerPainter(t,e){painterCtors[t]=e}export var version="5.1.0";